<html>

<!--includes-->
<script type="text/javascript" src = "https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
<script type="text/javascript" src = "https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>

<body>
  <div ng-controller="IndexController">

    <div class="list">
      <!--<label class="item item-input">-->
          <img src="/imags/NUwildcats.png" width="50px"; height="40px" style="float:left;">
          <div style="margin-left:50px; margin-top:10px; color:#9933ff; font-weight:bold; font-size:150%;">
          NU Bulletin Board
          </div>
      <!--</label>-->
    </div>
    <div class="list">
      <label class="item item-input item-select">
        <div class="input-label">
        Sort By:
        </div>
        <select id="sortSelect" onchange="sortEvents();" autocomplete="off">
          <option value="createdAt" selected>Most Recent</option>
          <option value="compensation">Compensation</option>
          <option value="duration">Duration</option>
          <!--<option value="rating">Rating</option>-->
        </select>
      </label>
    </div>
  </div>

<div id = "events"></div>

</body>

  <script type = "foo/bar" id = "eventTemplate">

  <ul class="list" ng-hide="events.length == 0">

     <div class="list" ng-controller="IndexController">
     <!--
        <a class="item item-thumbnail-left" href="#">
          <img src = "<%=posterIcon._url%>" height = "80" width="80" </img>
          <h2><%=study%></h2>
          <p><%="$" + compensation%>, <%=duration%></p>
          <p><%=location%></p>
          <p><%="Start date: " +startdate_str%></p>
          <p><%="End date: " + enddate_str%></p>
          <p><%=likeNum + " Likes"%> <%=dislikeNum + " Dislikes"%></p>
          <p><%=email%></p>
          <p>
              <span type = "button" id = "envelope" class = "icon super-email" style="font-size: 25px; float: right; padding: 10px" onclick = "test()"></span>
          </p>
        </a>
-->
      <div>
        <li>
          <div class="item">

            <super-navigate location="studyInfo#studyInfo" data-params-id='<%=testId%>'>
              <div class="item-thumbnail-left">
              <img style= "position:absolute; top:35px;  border-width: 4px" height:80px; width: 80px; src = "<%=posterIcon._url%>" </img>
                <div style="width:180px;word-break:break-word;">
                <h2 style="position:relative; right:20px;"><%=study%></h2>
                <p style= "position:relative; right:20px;"><span><%="$" + compensation%>, <%=duration%></span></p>
                <p style= "position:relative; right:20px;"><span><%=startdate_str%><%=" ~ " +enddate_str%></span></p>
                <p style= "position:relative; right:20px;"><span><%=location%></span></p>
                <p style= "position:relative; right:20px;"><span><%=likeNum + " Like"%> <%=dislikeNum + " Dislike"%></span></p>
                </div>
              </div>
            </super-navigate>
            <i class = "icon super-heart-broken" style="font-size: 25px; float: right; padding-right: 10px" onclick="addDislikeNum('<%=testId%>')"></i>
            <i class = "icon super-heart" style="font-size: 25px; float: right; padding-right: 20px" onclick="addLikeNum('<%=testId%>')"></i>
            <i class = "icon super-email" style="font-size: 25px; float: right; padding-right: 20px" onclick="sendEmail('<%=study%>', '<%=location%>')"></i>
          </div>
        </li>
      </div>


    </ul>

  </script>

  <script type="text/javascript">
    //Initialize/test Parse
    Parse.initialize("susDpNWLgi3QqeprNxBKeQ7uIJK0srYlde52neVb", "OMWpK5Oa17fiNcDyTkqvbKz2HHL6szH4jPYXlhz0");
     var TestObject = Parse.Object.extend("TestObject");
     var testObject = new TestObject();
     testObject.save({foo: "Frank124"}).then(function(object) {
     });

     //Create event template
     var template = $("#eventTemplate").html();
     us_template = _.template(template);

     //Keeps track of queried object
     var eventList = [];

     var createEvent = function(a)
     {
         eventList.push(a);
         $("#events").append(us_template(a));
     }

     function sortEvents()
     {
        //TODO: Allow ascending/descending?

         //Get sort order
         var ss = document.getElementById("sortSelect");  //Sorting select obj
         var sort_id = ss.options[ss.selectedIndex].value;   //Value of sorting selected

         alert(sort_id);

         //Sort events by sort_id option
         eventList.sort(function(a, b) {
              return (a[sort_id] < b[sort_id]) ? -1 : ((a[sort_id] > b[sort_id]) ? 1 : 0);
          });

         //Repopulate events div
         $("#events").empty();

         for(var i = 0; i < eventList.length; i++)
         {
            $("#events").append(us_template(eventList[i]));
         }
      };


     var EventObject = Parse.Object.extend("event");
     var query = new Parse.Query(EventObject);

     function getData()
     {
       //Get sort order
       var ss = document.getElementById("sortSelect");  //Sorting select obj
       var sort_id = ss.options[ss.selectedIndex].value;   //Value of sorting selected
           
       //query.descending(sort);  //Get items sorted
       query.descending(sort_id);

       query.find({
          success: function(results) {

            //alert("Found " + results.length + " items.")

           for(var i = 0; i < results.length; i++)  //The length of data should be mutable
           {
             var object = results[i].attributes;
             //test ID retrieval
             object.testId = results[i].id;

             //testForId = object.testId;

             createEvent(object);
           }

         document.getElementById("1").innerHTML = "success";
          },
         error: function(object, error) {

          document.getElementById("1").innerHTML = "error";
          }
        });
     }

     getData();


    function addLikeNum(id)
    {
      //alert("testForLike");
      var EventForVote = Parse.Object.extend("event");
      var query = new Parse.Query(EventForVote);

      query.get(id,{
        success: function(results) {
          results.increment('likeNum');
          results.save();
          alert(results.get('likeNum'));
          //alert(id);
          location.reload();
     },
       error: function(object, error) {
         alert("Error");
     }
    });

    }

    function addDislikeNum(id)
    {
      //alert("testForDislike");
      var EventForVote = Parse.Object.extend("event");
      var query = new Parse.Query(EventForVote);

      query.get(id,{
        success: function(results) {
          results.increment('dislikeNum');
          results.save();
          alert(results.get('dislikeNum'));
          //alert(id);
          location.reload();
     },
       error: function(object, error) {
         alert("Error");
     }
    });

    }



    function sendEmail(stu, loc)
    {

      var currentUser = Parse.User.current();
      var currentUserName = currentUser.get("username")
      var currentUserEmail = currentUser.get("email");
      alert(currentUserName);
      alert(currentUserEmail);
      if(confirm("Are you sure you want to send the email?") && currentUser)
      {
      $.ajax(
      {
         type: "POST",
         url: "https://mandrillapp.com/api/1.0/messages/send.json",
          data: {
            "key": "qgQsrDwIdACZ55h8AzrqIA",
            "message": {
                "from_email": currentUserEmail,
                "from_name": currentUserName,
                "to": [
                    {
                        "email": "lukeahn2013@u.northwestern.edu",
                        "name": "Professor",
                        "type": "to",
                    }
                      ],
                      "autotext": 'true',
                      "subject": "Research - " + stu,
                      "html": "Hello, I am interested in the research study, " + stu + ", located at " + loc + ". Please contact me."
                  }
            }
      }).done(function(response) {
       console.log(response); // if you're into that sorta thing
     });
      alert("SENT");
    }
    else
    {
      alert("please log in to send email")
    }
    }


   </script>


   <script>






  //$(function() {
   //$("#envelope").click(test);
    /* $.ajax({
     type: "POST",
     url: "https://mandrillapp.com/api/1.0/messages/send.json",
  data: {
    {
    "key": "qgQsrDwIdACZ55h8AzrqIA",
    "message": {
        "html": "<p>Example HTML content</p>",
        "text": "Example text content",
        "subject": "example subject",
        "from_email": "varunk93@hotmail.com",
        "from_name": "Example Name",
        "to": [
            {
                "email": "varunk93@hotmail.com",
                "name": "Recipient Name",
                "type": "to"
            }
        ],
        "images": [
            {
            }
        ]
    },
    "send_at": "4/22/15"
}
  }
 }).done(function(response) {
   console.log(response); // if you're into that sorta thing
 });
});
 }); */
   </script>


 <script >
   src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"
   </script>

<style>
    .container
    {
        width:100%;
    }
    #M-button
    {
        width:50%;
        display: inline !important;
    }
    #R-button
    {
        width:50%;
        display: inline !important;
    }
</style>



</html>
